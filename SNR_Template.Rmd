---
title: "Simple Normal Regression Analysis"
author: "`r Sys.info()[['effective_user']]`"
date: "`r Sys.time()`"
output: html_document
params:
  dataset: !r tibble::tibble()
  dependent_var: ""
  independent_var: ""
  n_chains: 4
  n_iter: 10000
  ci_pct: 95
  posterior_prob: !r c()
  posterior_predict: !r c()
  
---

# Parameters
1. Dataset: params$dataset
2. Depedent Variable: params$dependent_var
3. Independent Variable: params$independent_var
4. Number of stan chains: params$n_chains
5. Number of chain iterations: params$n_iter
6. Percentage to use in Credible Interval: params$ci_pct
7. Vector of relationships to calculate the posterior probability for (e.g. dependent variable > 1.2)
8. Vector of depdent variable values to predict indepdent variable values from (e.g. dependent variable = 5, what is potential model)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rstanarm)
library(bayesplot)
library(reshape2)
library(janitor)
```


### Plot of variables of interest
```{r}
data <- as.data.frame(params$dataset)
ggplot(params$dataset, aes_string(x = params$independent_var, y = params$dependent_var)) + geom_point()
```

### Building our model

```{r message=FALSE, results="hide"}
set.seed(84735)

## Convert character parameters to a formula

form <- as.formula(paste0(params$dependent_var, " ~ ", params$independent_var ))

## Pass that formula to normal_model_sim
normal_model_sim <- stan_glm(form, 
                              data = params$dataset,
                              family = gaussian,
                              chains = params$n_chains,
                              iter = params$n_iter)

```

### Diagnostics

```{r}
 
# Trace plots of parallel chains
mcmc_trace(normal_model_sim, size = 0.1)
 
# Density plots of parallel chains
mcmc_dens_overlay(normal_model_sim)
```

### Posterior Summary Statistics

```{r}
# Posterior summary statistics
model_summary <- summary(normal_model_sim)
head(as.data.frame(model_summary), -2)
```

best guess for regression equation:


### Credible Interval

```{r}
if(params$ci_pct > 1){
  frac <- params$ci_pct/100
}else{
  frac <- params$ci_pct
}

posterior_interval(normal_model_sim, prob = frac)
```

```{r}
 # Shade in the 90% CI. For example:
 mcmc_areas(normal_model_sim,
            pars = c(params$independent_var),
            prob = frac,
            point_est="mean")
```

### Practice Q1: part g

Creating a dataframe where the chains for each parameter are in one column

```{r}
# 
# normal_model_df <- as.array(normal_model_sim) %>%
# melt %>%
# pivot_wider(names_from = parameters, values_from = value)
```


### Practice Q1: part h

plotting the first 20 regression lines with the posterior mean regression line overlayed in blue
```{r}
# first_20 <- head(normal_model_df, 20)
# 
# ggplot(params$dataset, aes(x = params$independent_var, y = params$dependent_var)) +
#   geom_point(size = 0.1) +
#   geom_abline(data = first_20,
#               aes(intercept = `(Intercept)`, 
#                   slope = params$independent_var),
#               color = "orange",alpha=.8, size = 0.1) #+
  # NEED TO MAKE SURE THESE NUMBERS BELOW ARE PULLED FROM THE MODEL
 # geom_abline(aes(intercept = -2173.12, slope = 89.31),
  #            color = "blue")
```

We can also do this with first 200

```{r}
# first_200 <- head(normal_model_df, 200)
# 
# ggplot(params$dataset, aes(x = params$independent_var, y = params$dependent_var)) +
#   geom_point(size = 0.1) +
#   geom_abline(data = first_200,
#               aes(intercept = `(Intercept)`, 
#                   slope = params$independent_var),
#               color = "orange",alpha=.8, size = 0.1) #+
  # NEED TO MAKE SURE THESE NUMBERS BELOW ARE PULLED FROM THE MODEL
 # geom_abline(aes(intercept = -2173.12, slope = 89.31),
  #            color = "blue")
```


### Practice Q1: part i
Finding posterior probability that beta1>0

```{r}
# 
# normal_model_df %>%
#   mutate(exceeds_0 = temp_actual > 0) %>%
#   tabyl(exceeds_0)
```


### Practice Q1: part j (the non stan way)

make posterior predictions for when the temp is 58 degrees
```{r}
# set.seed(84735)
# predict_58 <- normal_model_df %>%
#   mutate(y_trend = `(Intercept)` + temp_actual*58) %>%
#   mutate(y_new = rnorm(20000, y_trend, sigma))
```


visualizing posterior y trend and posterior predictions when temp is 58:
```{r}
# ggplot(predict_58, aes(x = y_trend)) +geom_density()
# 
# ggplot(predict_58, aes(x = y_new)) +geom_density()
```

### Practice Q1: part j (the stan way)

let's use stan functions for posterior prediction!

We'll make a prediction for 72 degrees!
```{r}
# set.seed(84735)
# shortcut_prediction <- 
#   posterior_predict(normal_model_sim,
#                     newdata = data.frame(temp_actual = 72))
```

let's look at the denisty of posterior predictions
```{r}
# mcmc_dens(shortcut_prediction) +
# labs(x = "predicted ridership on a 72 degree day")
```