---
title: "Simple Normal Regression Analysis"
author: "`r Sys.info()[['effective_user']]`"
date: "`r Sys.time()`"
output: 
  html_document:
    code_folding: hide
params:
  data: !r tibble()
  x: ""
  y: ""
  n_chains: 4
  n_iter: 10000
  ci_pct: 95
  n_lines: 0
  posterior_prob: !r c()
  posterior_predict: !r c()
  
---

# Parameters
1. Data: params$data
2. Independent Variable: params$x
3. Depedent Variable: params$y
4. Number of stan chains: params$n_chains
5. Number of chain iterations: params$n_iter
6. Percentage to use in Credible Interval: params$ci_pct
7. Number of lines to include on the output with all the sample lines: params$n_liness
8. Vector of relationships to calculate the posterior probability for (e.g. dependent variable > 1.2): params$posterior_prob
9. Vector of depdent variable values to predict indepdent variable values from (e.g. dependent variable = 5, what is potential model): params$posterior_predict

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rstanarm)
library(bayesplot)
library(reshape2)
library(janitor)
library(bayesrules)

```


### Plot of variables of interest
```{r}

ggplot(params$data, aes_string(x = params$x, y = params$y)) + 
  geom_point() +
  ggtitle(paste0(params$y, " vs. ", params$x))

```

### Building our model

```{r message=FALSE, results="hide"}
set.seed(84735)

## Convert character parameters to a formula

form <- as.formula(paste0(params$y, " ~ ", params$x))

## Pass that formula to normal_model_sim

normal_model_sim <- stan_glm(form, 
  data = params$data,
  family = gaussian,
  chains = params$n_chains,
  iter = params$n_iter)

```

### Diagnostics

```{r}

# Trace plots of parallel chains
mcmc_trace(normal_model_sim, size = 0.1)

# Density plots of parallel chains
mcmc_dens_overlay(normal_model_sim)
```

### Posterior Summary Statistics

```{r}
# Posterior summary statistics
model_summary <- summary(normal_model_sim)
head(as.data.frame(model_summary), -2)
```

best guess for regression equation:


### Credible Interval

```{r}
if (params$ci_pct > 1) {
  frac <- params$ci_pct / 100
} else {
  frac <- params$ci_pct
}

posterior_interval(normal_model_sim, prob = frac)
```

```{r}
# Shade in the 90% CI. For example:
mcmc_areas(normal_model_sim,
  pars = c(params$x),
  prob = frac,
  point_est = "mean"
)
```

### Restructuring the dataframe

```{r}
normal_model_df <- as.array(normal_model_sim) %>%
  melt() %>%
  pivot_wider(names_from = parameters, values_from = value)
```


### Plotting potential regression lines from model

```{r}


if(params$n_lines == 0){
  num_lines <- round(nrow(params$data)/4)
}else{
  num_lines <- params$n_lines
}

first_n <- head(normal_model_df, num_lines)
intercept <- model_summary[1][1]
slope <- model_summary[2][1]

ggplot(params$data, aes_string(x = params$x, y = params$y)) +
  geom_point(size = 0.1) +
  geom_abline(
    data = first_n,
    aes_string(
      intercept = "`(Intercept)`",
      # issue here: have to access the x variable from the first_20 df not main df?
      slope = params$x
      ),
    color = "cadetblue1", alpha = .8, size = 0.1
  )+
  geom_abline(aes(intercept = intercept, slope = slope),
    color = "blue"
  )
```




```{r, echo = length(params$posterior_prob)>0, eval = length(params$posterior_prob)>0}

knitr::asis_output("### Posterior probability")
  
for(condition in params$posterior_prob){
  to_eval <- parse(text = paste0(params$x, condition))
  
  output <- normal_model_df %>%
  mutate(fits_condition = eval(to_eval)) %>%
  tabyl(fits_condition)
  print(paste0("Probability that ", params$y, " ", condition, " = ", output$percent[2]))
}



```




```{r, echo = length(params$posterior_predict)>0, eval = length(params$posterior_predict)>0}
knitr::asis_output("### Posterior predictions")

set.seed(84735)

for(prediction in params$posterior_predict){
  to_eval <- parse(text = paste0(params$x, " = ", prediction))
  shortcut_prediction <- posterior_predict(
  normal_model_sim,
  newdata = data.frame(eval(to_eval)))

  plot <- mcmc_dens(shortcut_prediction) +
  labs(x = paste0("Predicted ", params$y, " when ", params$x, " = ", prediction))
  
  print(plot)
}

```







# To-Do:

1. Add a section from the Evaluating Regression Models lecture (Ch 10) for the posterior predictive check and potentially cross validation.
2. Add in interpretations of output that are based on the output numbers in cases where they're possible.
3. Make the output pretty!
4. README + sample output HTMLs
5. See if we can accept things like x = temp_feel instead of x = "temp_feel"
